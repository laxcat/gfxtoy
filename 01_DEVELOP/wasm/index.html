<html>
<head>
    <meta charset="utf-8">
    <title></title>
</head>
<body>
<script type="module">

    const memory = new WebAssembly.Memory({ initial: 2, maximum: 2 })
    const heap = new Uint8Array(memory.buffer);
    console.log("heap size", heap.length);
    let wasm = null;

    WebAssembly.Memory.prototype.decodeCStr = function (ptr, size) {
        return (new TextDecoder()).decode(new Uint8Array(this.buffer, ptr, size));
    };

    WebAssembly.Memory.prototype.encodeCStr = function (str) {
        const size = str.length;
        const ptr = wasm.request_str_ptr(size);
        (new TextEncoder()).encodeInto(str, new Uint8Array(memory.buffer, ptr, size));
        return [ptr, size];
    };

    const logCStr = (ptr, size) => {
        console.log(memory.decodeCStr(ptr, size));
    };

    const imports = {
        env: {
            memory: memory,
            print_val: console.log,
            print_str: logCStr,
            print_err: logCStr,
        }
    };

    WebAssembly.instantiateStreaming(fetch("test.wasm"), imports).then(obj => {
        wasm = obj.instance.exports;
        wasm.test();
        const caps = str => {
            const [ptr, size] = memory.encodeCStr(str);
            wasm.caps(ptr);
            return memory.decodeCStr(ptr, size);
        }
        console.log("from js", caps("fart"));
        console.log("heap at", ptr, heap.slice(ptr, ptr+8));
        // console.log("caps", memory.decodeCStr(wasm.caps()));
    });

</script>
</body>
</html>
